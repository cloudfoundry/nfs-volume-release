#!/bin/bash
# vim: set ft=sh

set -e -x

root_path=./$(dirname $0)/../../..
scripts_path=./$(dirname $0)/..
eval $($scripts_path/get_paths.sh)

if [ "$(uname)" == "Darwin" ]; then
    export GOPATH=`greadlink -f ${scripts_path}/..`
else
    export GOPATH=`readlink -f ${scripts_path}/..`
fi
export PATH=$GOPATH/bin:$PATH

source ${scripts_path}/ci/utils.sh
check_param CF_USERNAME
check_param CF_API_ENDPOINT
check_param APPS_DOMAIN
check_param APPLICATION_PATH
check_param SERVICE_NAME
check_param PLAN_NAME
check_param CREATE_CONFIG
check_param BIND_CONFIG

# CF_PASSWORD and BROKER_PASSWORD can either be passed in as environment variables, or extracted from a deployment-vars file
# in environments where they are dynamically generated by BOSH
if [ -z "$CF_PASSWORD" ]; then
    ${root_path}/persi-ci/scripts/ci/bbl_get_bosh_env
    source bosh-env/set-env.sh

    bosh_manifest_password_variable_name=cf_admin_password
    CF_PASSWORD=`credhub find -j -n ${bosh_manifest_password_variable_name} | jq -r .credentials[].name | xargs credhub get -j -n | jq -r .value`
fi

if [ ! -z "$BROKER_PASSWORD_KEY" ]; then
    ${root_path}/persi-ci/scripts/ci/bbl_get_bosh_env
    source bosh-env/set-env.sh

    bosh_manifest_password_variable_name=$BROKER_PASSWORD_KEY
    BROKER_PASSWORD=`credhub find -j -n ${bosh_manifest_password_variable_name} | jq -r .credentials[].name | xargs credhub get -j -n | jq -r .value`
fi

pushd ${scripts_path}/../src/code.cloudfoundry.org/nfsbroker
  GOOS=linux GOARCH=amd64 go build -o bin/nfsbroker
  export BROKER_APPLICATION_PATH=$PWD
popd

go get github.com/onsi/ginkgo/ginkgo

PARALLEL_NODES=${PARALLEL_NODES} ${scripts_path}/run-pats \
"${CF_USERNAME}" \
"${CF_PASSWORD}" \
"${CF_API_ENDPOINT}" \
"${APPS_DOMAIN}" \
"${SERVICE_NAME}" \
"${PLAN_NAME}" \
"${BROKER_URL}" \
"${BROKER_USER}" \
"${BROKER_PASSWORD}" \
"${CREATE_CONFIG}" \
"${BIND_CONFIG}" \
"${DISALLOWED_LDAP_BIND_CONFIG}" \
"${CREATE_BOGUS_CONFIG}" \
"${BIND_BOGUS_CONFIG}" \
"${CREATE_LAZY_UNMOUNT_CONFIG}" \
"${LAZY_UNMOUNT_VM_INSTANCE}" \
"${TEST_ISOLATION_SEGMENT}"
